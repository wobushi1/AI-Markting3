name: Build EXE

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip' # 开启缓存，加速后续构建
        
    - name: Download and Setup Poppler
      shell: powershell
      run: |
        # 1. 下载 Poppler (使用已知稳定的 Release 链接)
        $Url = "https://github.com/oschwartz10612/poppler-windows/releases/download/v24.02.0-0/Release-24.02.0-0.zip"
        Write-Host "Downloading Poppler from $Url ..."
        Invoke-WebRequest -Uri $Url -OutFile poppler.zip
        
        # 2. 解压到临时目录 (防止文件夹名称不确定)
        Write-Host "Extracting..."
        Expand-Archive poppler.zip -DestinationPath poppler_temp
        
        # 3. 【关键修复】自动查找内部的 'bin' 文件夹
        # 不管解压出来的父文件夹叫什么名字，递归查找名为 'bin' 的目录
        $BinPath = Get-ChildItem -Path poppler_temp -Recurse -Directory -Filter "bin" | Select-Object -First 1 -ExpandProperty FullName
        
        if (-not $BinPath) {
            Write-Error "Could not find 'bin' directory inside the zip file!"
            exit 1
        }
        Write-Host "Found bin directory at: $BinPath"
        
        # 4. 创建最终目录结构并移动
        New-Item -ItemType Directory -Force -Path poppler
        Move-Item -Path $BinPath -Destination poppler/bin -Force
        
        # 5. 验证是否成功
        if (Test-Path "poppler/bin/pdftoppm.exe") {
            Write-Host "Poppler setup successfully!"
        } else {
            Write-Error "Poppler setup failed."
            exit 1
        }
      
    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        # 安装你项目所需的库
        pip install pyinstaller PyQt5 pdf2image requests openai Pillow python-docx
        
    - name: Build with PyInstaller
      # 注意：Windows下 --add-data 使用分号 ; 分隔
      # 将当前目录下的 poppler/bin 打包进 EXE 内部的 poppler/bin
      run: |
        pyinstaller --noconsole --onefile --name="EssayGrader" --add-data "poppler/bin;poppler/bin" main.py
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: EssayGrader-Windows
        path: dist/EssayGrader.exe
